# Roadmap - Nexo AI

Planejamento de implementa√ß√£o do projeto em fases.

---

## ‚úÖ Phase 1: Foundation (Semana 1) - **COMPLETO**

**Objetivo:** Setup b√°sico funcional

### Tasks

- [x] **1.1 Setup Inicial**

  - [x] Criar projeto Bun + Elysia
  - [x] Configurar TypeScript + tsconfig
  - [x] Setup Drizzle ORM
  - [x] Configurar `.env.example`

- [x] **1.2 Database Setup**

  - [x] Criar conta Supabase
  - [x] Definir schemas Drizzle (users, items, conversations, messages)
  - [x] Gerar migrations
  - [x] Aplicar migrations no Supabase
  - [x] Testar conex√£o local

- [x] **1.3 Basic API**

  - [x] Endpoint `GET /health`
  - [x] Logger setup (console wrapper)
  - [x] Error handling middleware
  - [x] Env validation (Zod)

- [x] **1.4 Deploy Teste**
  - [x] Deploy inicial Cloudflare Workers
  - [x] Configurar secrets
  - [x] Testar health endpoint em produ√ß√£o

**Entreg√°vel:** ‚úÖ API deployada respondendo `/health`

---

## ‚úÖ Phase 2: Multi-Provider Architecture (Semana 1-2) - **COMPLETO**

**Objetivo:** Integra√ß√£o com Telegram (padr√£o) + arquitetura preparada para m√∫ltiplos providers

### Tasks

- [x] **2.1 Adapter Layer**

  - [x] Criar interface `MessagingProvider`
  - [x] Implementar `TelegramAdapter` (padr√£o)
  - [x] Implementar `WhatsAppAdapter` (feature futura)
  - [x] Normalizar webhooks via `IncomingMessage`

- [x] **2.2 Multi-Provider Schema**

  - [x] Criar tabela `user_accounts` (provider + externalId)
  - [x] Refatorar `users` como entidade de dom√≠nio pura
  - [x] Implementar detec√ß√£o cross-provider por telefone
  - [x] Migrations para banco limpo

- [x] **2.3 Telegram Integration**
  - [x] Webhook `POST /webhook/telegram`
  - [x] Parse de mensagens Telegram Bot API
  - [x] Envio de respostas via `sendMessage`
  - [x] Valida√ß√£o opcional via `X-Telegram-Bot-Api-Secret-Token`

**Entreg√°vel:** ‚úÖ Bot Telegram funcional com unifica√ß√£o de usu√°rios

---

## üîÑ Phase 3: WhatsApp Integration (Feature Futura)

**Objetivo:** Adicionar suporte a WhatsApp quando necess√°rio

- [x] **2.1 Meta API Client**

  - [x] Service `whatsapp/index.ts`
  - [x] Fun√ß√£o `sendMessage()`
  - [x] Fun√ß√£o `markAsRead()`
  - [x] Tratamento de erros Meta API

- [x] **2.2 Webhook**

  - [x] Route `POST /webhook/meta`
  - [ ] Valida√ß√£o signature (X-Hub-Signature-256) - **TODO v0.2.0**
  - [x] Parsing payload Meta
  - [x] `GET /webhook/meta` (verification)

- [x] **2.3 Message Handler**

  - [x] Service `processMessage()` em webhook
  - [x] Extrair texto da mensagem
  - [x] Processar e responder
  - [x] Salvar mensagem no DB (table messages)

- [x] **2.4 Conversation Manager**

  - [x] Service `conversation-service.ts`
  - [x] `findOrCreateConversation()`
  - [x] `addMessage()`
  - [x] `getHistory()`

- [x] **2.5 Testes Integra√ß√£o**

  - [x] Enviar mensagem via WhatsApp
  - [x] Verificar resposta autom√°tica
  - [x] Verificar mensagem salva no DB

- [x] **2.6 Error Handling & Reliability**
  - [x] Tratamento robusto de erros com try-catch global
  - [x] Mensagens educadas quando LLM falha ou n√£o responde
  - [x] Garantir que bot sempre responda, mesmo com erros cr√≠ticos
  - [ ] **Feature: Conversa √önica Cross-Provider** - **TODO v0.3.0**
    - [ ] Implementar l√≥gica: apenas 1 conversa ativa (idle/em progresso) por usu√°rio
    - [ ] Contexto unificado: mesma conversa independente do provider (Telegram/WhatsApp)
    - [ ] Migra√ß√£o: adicionar campo `is_active` em `conversations`
    - [ ] Service: `findOrCreateConversation()` retorna sempre a mesma conversa ativa

**Entreg√°vel:** ‚úÖ Bot responde mensagens simples no WhatsApp

---

## ‚úÖ Phase 3: Multi-AI Integration (Semana 2) - **COMPLETO v0.1.0**

**Objetivo:** Multi-AI provider com Gemini (default) e Claude (fallback)

### Arquitetura

**Provider-agnostic architecture** permite trocar LLMs sem quebrar services.

```
conversation-service ‚Üí ai-service (interface)
                            ‚îú‚îÄ‚îÄ gemini-provider (DEFAULT)
                            ‚îî‚îÄ‚îÄ claude-provider (fallback)
```

**Default: Google Gemini**

- ‚úÖ Mais r√°pido (flash model)
- ‚úÖ Mais barato ($0.075/1M tokens vs $3/1M Claude)
- ‚úÖ Suporte nativo a portugu√™s
- ‚úÖ API simples e est√°vel

**Fallback: Claude**

- ‚úÖ Mais sofisticado (reasoning avan√ßado)
- ‚úÖ Tool calling robusto
- ‚úÖ Usado automaticamente se Gemini falhar

### Tasks

- [x] **3.1 AI Provider Interface**

  - [x] Service `ai/types.ts` ‚Üí interface `AIProvider`
  - [x] Types: `AIProviderType`, `Message`, `AIResponse`
  - [x] M√©todo `callLLM()` padronizado

- [x] **3.2 Gemini Provider** (v0.1.0)

  - [x] Service `ai/gemini-provider.ts`
  - [x] Integra√ß√£o com Google Generative AI SDK
  - [x] Model: `gemini-1.5-flash` (default)
  - [x] History conversion (user/assistant ‚Üí user/model)
  - [x] Error handling (API key, rate limit)

- [x] **3.3 Claude Provider** (v0.1.0)

  - [x] Service `ai/claude-provider.ts`
  - [x] Integra√ß√£o com Anthropic SDK
  - [x] Model: `claude-3-5-sonnet-20241022`
  - [x] Error handling (401, 429)

- [x] **3.4 AI Service Facade** (v0.1.0)

  - [x] Service `ai/index.ts`
  - [x] Multi-provider manager com Map
  - [x] Fallback autom√°tico em caso de erro
  - [x] M√©todos: `setProvider()`, `getCurrentProvider()`, `getAvailableProviders()`
  - [x] Singleton com Gemini como default

- [x] **3.5 Conversation Service Integration**

  - [x] `conversation-service.ts` usa `aiService.callLLM()`
  - [x] Manter hist√≥rico de mensagens
  - [x] Contexto de conversa√ß√£o (state + context JSONB)

- [x] **3.6 State Machine** (v0.1.0)

  - [x] Estados: idle, awaiting_confirmation, enriching, saving, error
  - [x] Transi√ß√µes entre estados
  - [x] Salvar estado no DB (conversations.state)

- [ ] **3.7 Tool Definitions** - **TODO v0.2.0**

  - [ ] File `ai/tools.ts`
  - [ ] Tool: `save_item`
  - [ ] Tool: `search_items`
  - [ ] Tool: `get_item_details`
  - [ ] Tool: `enrich_metadata`

- [ ] **3.8 Tool Execution** - **TODO v0.2.0**

  - [ ] Executar tool calls do LLM
  - [ ] Retornar resultados ao LLM
  - [ ] Loop at√© LLM ter resposta final

- [ ] **3.9 Environment Configuration** - **TODO v0.2.0**
  - [x] `GOOGLE_API_KEY` (required se Gemini ativo)
  - [x] `ANTHROPIC_API_KEY` (optional, fallback)
  - [ ] Valida√ß√£o: pelo menos 1 provider deve estar configurado
  - [ ] Default provider via env: `DEFAULT_AI_PROVIDER=gemini`

### Exemplo de Uso

```typescript
import { aiService } from "@/services/ai";

// Usa provider default (Gemini)
const response = await aiService.callLLM({
  message: "Salve o filme Inception",
  history: previousMessages,
  systemPrompt: "Voc√™ √© um assistente...",
});

// For√ßa uso de Claude
aiService.setProvider("claude");

// Verifica provider ativo
console.log(aiService.getCurrentProvider()); // "claude"

// Lista dispon√≠veis
console.log(aiService.getAvailableProviders()); // ["gemini", "claude"]
```

### Compara√ß√£o de Providers

| M√©trica          | Gemini 1.5 Flash     | Claude 3.5 Sonnet  |
| ---------------- | -------------------- | ------------------ |
| **Custo Input**  | $0.075/1M tokens     | $3.00/1M tokens    |
| **Custo Output** | $0.30/1M tokens      | $15.00/1M tokens   |
| **Lat√™ncia**     | ~300ms               | ~500ms             |
| **Context**      | 1M tokens            | 200K tokens        |
| **Reasoning**    | ‚≠ê‚≠ê‚≠ê               | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê         |
| **Tool Calling** | ‚úÖ (b√°sico)          | ‚úÖ (avan√ßado)      |
| **Portugu√™s**    | ‚úÖ Nativo            | ‚úÖ Excelente       |
| **Rate Limit**   | 1500 RPM (free tier) | 50 RPM (free tier) |

**Decis√£o:** Gemini para 90% dos casos (classifica√ß√£o, enrichment, respostas simples). Claude apenas para tool calling complexo ou se Gemini falhar.

### Dependencies

```json
{
  "dependencies": {
    "@anthropic-ai/sdk": "^0.32.1",
    "@google/generative-ai": "^0.21.0"
  }
}
```

### Environment Variables

```bash
# .env (pelo menos 1 deve estar configurado)
GOOGLE_API_KEY="AIza..." # Gemini API key (default)
ANTHROPIC_API_KEY="sk-ant-..." # Claude API key (fallback)
DEFAULT_AI_PROVIDER="gemini" # opcional, default j√° √© gemini
```

**Entreg√°vel:** ‚úÖ Multi-AI com Gemini (default) e Claude (fallback) implementado

---

## ‚úÖ Phase 4: Enrichment Services (Semana 2-3) - **COMPLETO**

**Objetivo:** Enriquecer items com metadados externos

### Tasks

- [x] **4.1 TMDB Integration**

  - [x] Service `enrichment/tmdb-service.ts`
  - [x] `searchMovies(query)` ‚Üí resultados
  - [x] `getMovieDetails(tmdb_id)` ‚Üí metadata completo
  - [ ] `getStreamingProviders(tmdb_id, region='BR')` - **TODO**
  - [ ] Tratamento rate limit (40/10s) - **TODO v0.2.0**
  - [ ] Cache responses - **TODO v0.2.0**

- [x] **4.2 YouTube Integration**

  - [x] Service `enrichment/youtube-service.ts`
  - [x] `extractVideoId(url)` ‚Üí video_id
  - [x] `getVideoDetails(video_id)` ‚Üí metadata
  - [ ] Tratamento quota (10k units/day) - **TODO v0.2.0**

- [x] **4.3 OpenGraph Parser**

  - [x] Service `enrichment/opengraph-service.ts`
  - [x] `fetchMetadata(url)` ‚Üí fetch HTML
  - [x] `parseOGTags(html)` ‚Üí structured data
  - [x] Fallback para meta tags normais

- [x] **4.4 Enrichment Facade**

  - [x] Service `enrichment/index.ts`
  - [x] `enrich(type, data)` ‚Üí detecta tipo e chama servi√ßo correto

- [x] **4.5 Classifier**
  - [x] Service `classifier-service.ts`
  - [x] `detectType(text)` ‚Üí infere tipo (movie, link, note, etc)
  - [x] `extractQuery(text, type)` ‚Üí extrai t√≠tulo, etc
  - [ ] Usar Claude se amb√≠guo - **TODO v0.3.0**

**Entreg√°vel:** ‚úÖ Items salvos com metadados ricos

---

## üéØ Phase 4.5: Interactive UI Components (Feature Futura)

**Objetivo:** Usar bot√µes e selects nativos do Telegram/WhatsApp para melhorar UX

### Contexto

Atualmente quando h√° m√∫ltiplos filmes, o bot envia uma lista de texto e pede que o usu√°rio digite um n√∫mero. Com bot√µes inline ou quick replies, a experi√™ncia fica mais intuitiva e profissional.

**Use Cases:**

- Lista de filmes ‚Üí Inline Keyboard com bot√µes clic√°veis
- Confirma√ß√£o ‚Üí Quick reply buttons ("Sim" / "N√£o")
- Menu de a√ß√µes ‚Üí Persistent menu ou comando buttons

### Tasks

- [ ] **4.5.1 Telegram Inline Keyboards**

  - [ ] Atualizar `telegram-adapter.ts` ‚Üí m√©todo `sendMessageWithButtons()`
  - [ ] Tipo: `InlineKeyboardButton` com `callback_data`
  - [ ] Handler de callback queries (`POST /webhook/telegram`)
  - [ ] Atualizar lista de filmes para usar bot√µes ao inv√©s de texto
  - [ ] Exemplo: `[Button: "Fight Club (1999)"]` ‚Üí callback_data: `select_movie_123`

- [ ] **4.5.2 WhatsApp Interactive Messages**

  - [ ] Atualizar `whatsapp-adapter.ts` ‚Üí m√©todo `sendInteractiveList()`
  - [ ] Tipo: `list` message com sections e rows
  - [ ] Handler de interactive responses no webhook
  - [ ] M√°ximo 10 itens por lista (limita√ß√£o WhatsApp)
  - [ ] Fallback para texto se lista > 10 itens

- [ ] **4.5.3 Adapter Interface Update**

  - [ ] Adicionar m√©todo opcional `supportsInteractive()` na interface
  - [ ] Criar type `InteractiveOptions` para bot√µes/listas
  - [ ] Fallback autom√°tico para texto se provider n√£o suportar

- [ ] **4.5.4 Conversation Service Integration**
  - [ ] Detectar quando enviar UI interativa vs texto simples
  - [ ] Processar callbacks/responses interativas no state machine
  - [ ] Manter compatibilidade com input de texto livre

**Entreg√°vel:** üéØ Experi√™ncia visual com bot√µes e selects para confirmar filmes

---

## ÔøΩ Phase 8: Productivity Integrations (Feature Futura)

**Objetivo:** Integrar com Google Calendar e Microsoft To Do para gerenciamento de eventos e tarefas

### Contexto

Permitir que o assistente crie automaticamente eventos e tarefas quando detectar inten√ß√£o do usu√°rio, estendendo funcionalidade al√©m de simples "salvar para depois".

**Use Cases:**

- "reuni√£o com jo√£o amanh√£ √†s 15h" ‚Üí cria evento no Google Calendar
- "ver esse artigo depois" ‚Üí cria task no Microsoft To Do
- "lembrar de ligar pro dentista na quinta" ‚Üí cria lembrete

### Tasks

- [ ] **8.1 Google Calendar Integration**

  - [ ] OAuth 2.0 setup (Google Cloud Console)
  - [ ] Service `integrations/google-calendar.ts`
  - [ ] M√©todos: `createEvent()`, `listEvents()`, `updateEvent()`
  - [ ] Detec√ß√£o de inten√ß√£o via LLM (evento vs nota)
  - [ ] Parse de data/hora natural ("amanh√£ √†s 15h" ‚Üí ISO timestamp)
  - [ ] Confirma√ß√£o de evento antes de criar
  - [ ] Salvar refer√™ncia no items (type: "event")

- [ ] **8.2 Microsoft To Do Integration**

  - [ ] OAuth 2.0 setup (Azure AD)
  - [ ] Service `integrations/microsoft-todo.ts`
  - [ ] M√©todos: `createTask()`, `listTasks()`, `updateTask()`
  - [ ] Detec√ß√£o de inten√ß√£o via LLM (tarefa vs nota)
  - [ ] Suporte a due date opcional
  - [ ] Confirma√ß√£o de tarefa antes de criar
  - [ ] Salvar refer√™ncia no items (type: "task")

- [ ] **8.3 Database Schema**

  ```sql
  -- Adicionar novos tipos
  ALTER TYPE item_type ADD VALUE 'event';
  ALTER TYPE item_type ADD VALUE 'task';

  -- Metadata para eventos
  -- items.metadata (type: event)
  {
    "calendar_id": "primary",
    "event_id": "abc123",
    "start_time": "2026-01-15T15:00:00Z",
    "end_time": "2026-01-15T16:00:00Z",
    "attendees": ["joao@example.com"],
    "location": "Escrit√≥rio"
  }

  -- Metadata para tarefas
  -- items.metadata (type: task)
  {
    "list_id": "AQMkADAwAT...",
    "task_id": "AAMkADAwAT...",
    "due_date": "2026-01-20",
    "status": "notStarted" | "inProgress" | "completed",
    "importance": "low" | "normal" | "high"
  }
  ```

- [ ] **8.4 Intent Detection**

  - [ ] Prompt engineering para detectar eventos vs tarefas vs notas
  - [ ] Keywords: "reuni√£o", "compromisso", "evento" ‚Üí event
  - [ ] Keywords: "tarefa", "fazer", "lembrar" ‚Üí task
  - [ ] Extraction de data/hora usando LLM tool calling
  - [ ] Fallback para note se amb√≠guo

- [ ] **8.5 Authentication Flow**

  - [ ] Endpoint `/auth/google/callback`
  - [ ] Endpoint `/auth/microsoft/callback`
  - [ ] Armazenar tokens OAuth em `user_accounts` table
  - [ ] Refresh token autom√°tico quando expirar
  - [ ] Link account via mensagem WhatsApp/Telegram

- [ ] **8.6 Testing & Error Handling**
  - [ ] Testar cria√ß√£o de evento via mensagem
  - [ ] Testar cria√ß√£o de tarefa via mensagem
  - [ ] Error handling: token expirado, permiss√µes negadas
  - [ ] Rate limit das APIs (Google: 1000 req/100s, Microsoft: 2000 req/sec)

### Environment Variables

```bash
# .env
GOOGLE_CLIENT_ID="xxx.apps.googleusercontent.com"
GOOGLE_CLIENT_SECRET="GOCSPX-xxx"
GOOGLE_REDIRECT_URI="https://nexo-ai.com/auth/google/callback"

MICROSOFT_CLIENT_ID="xxx-xxx-xxx-xxx"
MICROSOFT_CLIENT_SECRET="xxx~xxx"
MICROSOFT_REDIRECT_URI="https://nexo-ai.com/auth/microsoft/callback"
```

### Dependencies

```json
{
  "dependencies": {
    "googleapis": "^134.0.0",
    "@microsoft/microsoft-graph-client": "^3.0.7",
    "@azure/msal-node": "^2.15.0"
  }
}
```

### Example Flow

```
Usu√°rio: "reuni√£o com time de produto amanh√£ √†s 14h"

Bot: ü§î Detectei um evento:
     üìÖ 15/01/2026 √†s 14:00
     üìù Reuni√£o com time de produto

     Criar no Google Calendar?
     [Sim] [N√£o] [Editar]

Usu√°rio: "sim"

Bot: ‚úÖ Evento criado no Google Calendar!
     üîó Link: https://calendar.google.com/event?eid=...
```

**Entreg√°vel:** Integra√ß√£o com Google Calendar e Microsoft To Do funcionais

---

## üîÆ Phase 9: Semantic Search with pgvector (Feature Futura)

**Objetivo:** Implementar busca sem√¢ntica com embeddings para encontrar conte√∫do por similaridade

### Contexto

Busca atual √© **estruturada** (JSONB + GIN indexes). Busca sem√¢ntica permite queries como:

- "me mostra filmes parecidos com Inception"
- "artigos sobre programa√ß√£o que salvei"
- "aquele v√≠deo sobre culin√°ria italiana"

**Quando implementar:**

- ‚úÖ > 500 items por usu√°rio (busca estruturada fica limitada)
- ‚úÖ Feedback de usu√°rios sobre "n√£o encontrei X"
- ‚úÖ Need de recomenda√ß√µes inteligentes

### Tasks

- [ ] **9.1 pgvector Setup**

  - [ ] Instalar extens√£o pgvector no Postgres
  - [ ] Migration: `CREATE EXTENSION IF NOT EXISTS vector`
  - [ ] Adicionar coluna `items.embedding vector(1536)` (OpenAI ada-002)
  - [ ] Criar √≠ndice: `CREATE INDEX ON items USING ivfflat (embedding vector_cosine_ops)`

- [ ] **9.2 Embedding Generation**

  - [ ] Service `embeddings/embedding-service.ts`
  - [ ] Integra√ß√£o com OpenAI Embeddings API ou Gemini Embeddings
  - [ ] M√©todo `generateEmbedding(text: string): Promise<number[]>`
  - [ ] Pipeline async: ao salvar item ‚Üí gera embedding ‚Üí atualiza DB
  - [ ] Batch processing para items existentes (migration)

- [ ] **9.3 Semantic Search**

  - [ ] Service `search/semantic-search.ts`
  - [ ] M√©todo `searchByEmbedding(query: string, userId: string, limit: number)`
  - [ ] Query: `SELECT * FROM items WHERE user_id = $1 ORDER BY embedding <=> $2 LIMIT $3`
  - [ ] Combinar com filtros estruturados (type, date, etc)
  - [ ] Threshold de similaridade (ex: cosine similarity > 0.7)

- [ ] **9.4 Hybrid Search**

  - [ ] Combinar busca sem√¢ntica + busca estruturada
  - [ ] Scoring: 0.7 _ semantic_score + 0.3 _ keyword_match
  - [ ] Deduplica√ß√£o de resultados
  - [ ] Re-ranking por relev√¢ncia

- [ ] **9.5 Recommendations**

  - [ ] M√©todo `recommendSimilar(itemId: string, limit: number)`
  - [ ] Buscar items com embedding similar ao item de refer√™ncia
  - [ ] Excluir item original dos resultados
  - [ ] Personaliza√ß√£o: priorizar items n√£o vistos

- [ ] **9.6 Database Schema**

  ```sql
  -- Migration: adicionar embedding column
  ALTER TABLE items
  ADD COLUMN embedding vector(1536);

  -- √çndice IVFFlat para busca r√°pida (ap√≥s popular dados)
  CREATE INDEX items_embedding_idx
  ON items USING ivfflat (embedding vector_cosine_ops)
  WITH (lists = 100);

  -- √çndice GIN para busca h√≠brida
  CREATE INDEX items_hybrid_idx
  ON items USING gin (to_tsvector('portuguese', title || ' ' || coalesce(description, '')));
  ```

- [ ] **9.7 Embedding Provider Selection**

  - [ ] Op√ß√£o 1: OpenAI `text-embedding-ada-002` (1536 dims, $0.0001/1k tokens)
  - [ ] Op√ß√£o 2: Gemini `embedding-001` (768 dims, free tier)
  - [ ] Op√ß√£o 3: Open source (Sentence Transformers, self-hosted)
  - [ ] Decis√£o: Gemini embedding (custo zero, integra√ß√£o j√° existente)

- [ ] **9.8 Testing & Optimization**
  - [ ] Testar precis√£o de busca (recall@10)
  - [ ] Benchmark de lat√™ncia (query < 100ms)
  - [ ] Otimizar `ivfflat lists` parameter
  - [ ] Cache de embeddings frequentes

### Environment Variables

```bash
# .env (se usar OpenAI embeddings)
# OPENAI_API_KEY="sk-..." # opcional, Gemini j√° est√° configurado
```

### Example Queries

```typescript
// Busca sem√¢ntica
const results = await semanticSearch.search({
  query: "filmes sobre viagem no tempo",
  userId: "user123",
  limit: 10,
  filters: { type: "movie" },
});

// Recomenda√ß√µes
const similar = await semanticSearch.recommendSimilar({
  itemId: "item-inception",
  limit: 5,
  excludeTypes: ["note"], // apenas filmes/v√≠deos
});
```

### Compara√ß√£o: Busca Estruturada vs Sem√¢ntica

| Aspecto        | Estruturada (atual) | Sem√¢ntica (pgvector)    |
| -------------- | ------------------- | ----------------------- |
| **Query type** | Keywords exatos     | Similaridade            |
| **Lat√™ncia**   | < 10ms              | < 100ms                 |
| **Custo**      | $0                  | ~$0.50/m√™s (embeddings) |
| **Setup**      | Simples             | Complexo                |
| **Precis√£o**   | Alta (keywords)     | Alta (conceitos)        |
| **Use case**   | "Fight Club 1999"   | "filmes tipo Inception" |

**Decis√£o:** Implementar busca sem√¢ntica **apenas quando necess√°rio** (> 500 items/user ou feedback negativo de busca).

**Entreg√°vel:** Busca sem√¢ntica com pgvector + embeddings (quando atingir crit√©rios)

---

## üîÆ Phase 10: Telegram Web Login (Feature Futura)

**Objetivo:** Permitir autentica√ß√£o de usu√°rios externos via Telegram Login Widget

### Descri√ß√£o T√©cnica

O [Telegram Login Widget](https://core.telegram.org/widgets/login) permite que sites autentiquem usu√°rios usando suas contas Telegram, oferecendo uma alternativa r√°pida e sem necessidade de senhas. Integra√ß√£o nativa e segura com o ecossistema Telegram.

### Caso de Uso

Usu√°rios acessam dashboard web do Nexo AI ‚Üí clicam no bot√£o "Login com Telegram" ‚Üí s√£o redirecionados para confirma√ß√£o no app Telegram ‚Üí retornam autenticados com dados verificados (id, nome, foto, username).

### Arquitetura T√©cnica

#### **Backend: Configura√ß√£o do Bot**

1. **Registro de Dom√≠nio**

   - Comando no [@BotFather](https://t.me/botfather): `/setdomain`
   - Vincular dom√≠nio verificado ao bot (ex: `app.nexo-ai.com`)
   - Bot deve ter nome/logo alinhados com marca

2. **Estrutura de Dados**

```typescript
// Novo campo em users table
interface User {
  id: string;
  telegram_id?: number; // ID Telegram vinculado
  telegram_username?: string;
  telegram_photo_url?: string;
  telegram_auth_date?: Date;
  // ... campos existentes
}
```

3. **Endpoint de Callback**

```typescript
// routes/auth/telegram-callback.ts
POST / PUT / auth / telegram / callback;

interface TelegramAuthData {
  id: number; // Telegram user ID
  first_name: string;
  last_name?: string;
  username?: string;
  photo_url?: string;
  auth_date: number; // Unix timestamp
  hash: string; // HMAC-SHA-256 signature
}

// Valida√ß√£o de autenticidade
function verifyTelegramAuth(data: TelegramAuthData): boolean {
  // 1. Criar data-check-string ordenado alfabeticamente
  const dataCheckString = Object.keys(data)
    .filter((key) => key !== "hash")
    .sort()
    .map((key) => `${key}=${data[key]}`)
    .join("\n");

  // 2. Gerar secret key: SHA256(bot_token)
  const secretKey = crypto
    .createHash("sha256")
    .update(env.TELEGRAM_BOT_TOKEN)
    .digest();

  // 3. Calcular HMAC-SHA-256
  const hmac = crypto
    .createHmac("sha256", secretKey)
    .update(dataCheckString)
    .digest("hex");

  // 4. Comparar hashes
  return hmac === data.hash;
}

// Handler
async function handleTelegramLogin(data: TelegramAuthData) {
  // Validar assinatura
  if (!verifyTelegramAuth(data)) {
    throw new Error("Invalid Telegram auth signature");
  }

  // Verificar tempo (max 24h)
  const now = Math.floor(Date.now() / 1000);
  if (now - data.auth_date > 86400) {
    throw new Error("Auth data expired");
  }

  // Buscar ou criar usu√°rio
  let user = await db.query.users.findFirst({
    where: eq(users.telegram_id, data.id),
  });

  if (!user) {
    user = await userService.createFromTelegram({
      telegram_id: data.id,
      telegram_username: data.username,
      name: `${data.first_name} ${data.last_name || ""}`.trim(),
      telegram_photo_url: data.photo_url,
      telegram_auth_date: new Date(data.auth_date * 1000),
    });
  }

  // Gerar JWT session token
  const token = jwt.sign({ userId: user.id }, env.JWT_SECRET, {
    expiresIn: "7d",
  });

  return { token, user };
}
```

#### **Frontend: Widget Integration**

1. **Widget HTML Embed**

```html
<!-- P√°gina de login -->
<script
  async
  src="https://telegram.org/js/telegram-widget.js?22"
  data-telegram-login="nexo_ai_bot"
  data-size="large"
  data-radius="8"
  data-auth-url="https://app.nexo-ai.com/auth/telegram/callback"
  data-request-access="write"
></script>
```

**Par√¢metros do Widget:**

- `data-telegram-login`: username do bot (sem @)
- `data-size`: `small` | `medium` | `large`
- `data-radius`: border-radius customizado
- `data-auth-url`: URL de callback (server-side)
- `data-onauth`: callback JS (client-side alternative)
- `data-request-access`: `write` para permitir bot enviar mensagens

2. **Callback Redirect**

```javascript
// Ap√≥s auth, Telegram redireciona para:
// https://app.nexo-ai.com/auth/telegram/callback?id=123456&first_name=John&hash=abc...

// Frontend captura params
const params = new URLSearchParams(window.location.search);
const authData = {
  id: parseInt(params.get("id")),
  first_name: params.get("first_name"),
  last_name: params.get("last_name"),
  username: params.get("username"),
  photo_url: params.get("photo_url"),
  auth_date: parseInt(params.get("auth_date")),
  hash: params.get("hash"),
};

// Envia para backend validar
fetch("/api/auth/telegram/verify", {
  method: "POST",
  body: JSON.stringify(authData),
})
  .then((res) => res.json())
  .then(({ token }) => {
    localStorage.setItem("auth_token", token);
    window.location.href = "/dashboard";
  });
```

3. **Alternative: Client-Side Callback**

```html
<script
  async
  src="https://telegram.org/js/telegram-widget.js?22"
  data-telegram-login="nexo_ai_bot"
  data-size="large"
  data-onauth="onTelegramAuth(user)"
></script>

<script>
  function onTelegramAuth(user) {
    // user = { id, first_name, last_name, username, photo_url, auth_date, hash }
    fetch("/api/auth/telegram/verify", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(user),
    })
      .then((res) => res.json())
      .then(({ token }) => {
        localStorage.setItem("auth_token", token);
        window.location.href = "/dashboard";
      });
  }
</script>
```

#### **Security Considerations**

1. **HMAC Verification**

   - SEMPRE validar hash usando SHA256(bot_token)
   - Rejeitar se assinatura inv√°lida

2. **Timestamp Validation**

   - Verificar `auth_date` (m√°x 24h)
   - Prevenir replay attacks

3. **HTTPS Required**
   - Widget s√≥ funciona em HTTPS
   - Exce√ß√£o: `localhost` para dev

#### **Database Migration**

```sql
-- Migration: add telegram auth fields
ALTER TABLE users
ADD COLUMN telegram_id BIGINT UNIQUE,
ADD COLUMN telegram_username TEXT,
ADD COLUMN telegram_photo_url TEXT,
ADD COLUMN telegram_auth_date TIMESTAMP;

CREATE INDEX idx_users_telegram_id ON users(telegram_id);
```

### Dependencies

```json
{
  "dependencies": {
    "jsonwebtoken": "^9.0.2" // Para session tokens
  },
  "devDependencies": {
    "@types/jsonwebtoken": "^9.0.5"
  }
}
```

### Environment Variables

```bash
# .env
JWT_SECRET="your-random-secret-key"
TELEGRAM_BOT_TOKEN="123456:ABC-DEF..." # J√° existe
APP_URL="https://app.nexo-ai.com" # Frontend URL
```

### Testing Flow

1. **Local Dev**

   - Usar `ngrok` ou Cloudflare Tunnel para expor localhost
   - Configurar dom√≠nio tempor√°rio no @BotFather
   - Testar widget em `http://localhost:3000` (permitido em dev)

2. **Staging**

   - Deploy em `staging.nexo-ai.com`
   - Configurar dom√≠nio no @BotFather
   - Validar HMAC e timestamps

3. **Production**
   - `app.nexo-ai.com` com SSL
   - Monitorar logs de auth failures
   - Rate limiting (max 10 auth/min/IP)

### Alternative: Inline Login (Advanced)

Para apps Telegram nativos, usar [LoginUrl](https://core.telegram.org/bots/api#loginurl) em bot√µes inline:

```typescript
await telegramAdapter.sendMessageWithButtons(chatId, "Acesse seu dashboard:", [
  {
    text: "üîê Login no Dashboard",
    login_url: {
      url: "https://app.nexo-ai.com/auth/telegram",
      request_write_access: true,
    },
  },
]);
```

### Roadmap Implementation

- **Phase 8.1**: Backend auth endpoint + HMAC validation
- **Phase 8.2**: Frontend widget integration
- **Phase 8.3**: JWT session management
- **Phase 8.4**: Link Telegram accounts to existing users
- **Phase 8.5**: Dashboard permissions based on Telegram ID

**Prioridade:** Baixa (ap√≥s dashboard web estar completo)

**Refer√™ncias:**

- [Telegram Login Widget](https://core.telegram.org/widgets/login)
- [Bot Features: Web Login](https://core.telegram.org/bots/features#web-login)
- [Sample Code (PHP)](https://gist.github.com/anonymous/6516521b1fb3b464534fbc30ea3573c2)

---

## üöß Phase 5: Items CRUD API (Semana 3) - **EM ANDAMENTO**

**Objetivo:** API REST completa para gerenciar items

### Tasks

- [x] **5.1 Repository Pattern**

  - [x] Service `item-service.ts`
  - [x] `createItem()` ‚Üí INSERT
  - [x] `getItemById()` ‚Üí SELECT
  - [x] `searchItems()` ‚Üí SELECT com WHERE
  - [ ] `updateItem()` ‚Üí UPDATE - **TODO**
  - [x] `deleteItem()` ‚Üí DELETE

- [x] **5.2 REST Endpoints**

  - [x] `GET /items` (lista com filtros)
  - [x] `GET /items/:id` (detalhes)
  - [ ] `POST /items` (criar manual) - **TODO**
  - [ ] `PATCH /items/:id` (atualizar) - **TODO**
  - [x] `DELETE /items/:id` (deletar)

- [x] **5.3 Advanced Search**

  - [x] `POST /items/search` (query b√°sica)
  - [ ] Full-text search (PostgreSQL tsvector) - **TODO v0.3.0**
  - [ ] Filtros: tags, status, yearRange, hasStreaming - **TODO v0.3.0**
  - [ ] Ordena√ß√£o por metadata (JSONB) - **TODO v0.3.0**

- [ ] **5.4 Stats Endpoint** - **TODO v0.3.0**

  - [ ] `GET /items/stats`
  - [ ] Total items
  - [ ] Breakdown por type/status
  - [ ] Top tags
  - [ ] Recent activity

- [ ] **5.5 Validations & Schemas** - **TODO v0.2.0**
  - [ ] Zod schemas para cada endpoint
  - [x] OpenAPI documentation (Swagger)
  - [ ] Error responses padronizados

**Entreg√°vel:** API REST completa e documentada

---

## üìã Phase 6: MCP Server (Semana 3-4) - **PLANEJADO**

**Objetivo:** Expor MCP protocol para Claude Desktop/CLI e composi√ß√£o com MCP Supabase

### Contexto: MCP Composition

**Sim, MCP servers podem se comunicar entre si!** O Model Context Protocol suporta composi√ß√£o via:

1. **MCP Supabase Client** - Nexo AI pode usar o [MCP oficial do Supabase](https://github.com/modelcontextprotocol/servers/tree/main/src/supabase) para queries SQL diretas
2. **Proxy Pattern** - Nexo AI MCP age como proxy, delegando opera√ß√µes de DB para Supabase MCP
3. **Multi-Server Config** - Claude Desktop conecta a ambos MCPs simultaneamente

**Arquitetura Proposta:**

```
Claude Desktop
    ‚îú‚îÄ‚îÄ [Nexo AI MCP] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí Business Logic + AI Actions
    ‚îî‚îÄ‚îÄ [Supabase MCP] ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí Direct SQL Queries (read-only)
```

**Benef√≠cios:**

- ‚úÖ Nexo AI MCP foca em a√ß√µes de neg√≥cio (`save_item`, `enrich_metadata`)
- ‚úÖ Supabase MCP permite SQL queries diretas (analytics, debug)
- ‚úÖ Claude pode escolher qual MCP usar conforme contexto

### Tasks

- [ ] **6.1 MCP Server Setup**

  - [ ] Service `mcp/server.ts`
  - [ ] Implementar MCP protocol spec
  - [ ] Registrar no Elysia
  - [ ] Configurar `claude_desktop_config.json` para multi-server

- [ ] **6.2 MCP Resources**

  - [ ] `nexo://items/user/{userId}` ‚Üí lista items
  - [ ] `nexo://items/user/{userId}/type/{type}` ‚Üí filtrado por tipo
  - [ ] `nexo://conversations/{conversationId}` ‚Üí hist√≥rico de conversa
  - [ ] Read-only access (queries complexas via Supabase MCP)

- [ ] **6.3 MCP Tools (Business Actions)**

  - [ ] Tool: `save_item` ‚Üí salva item com enrichment
  - [ ] Tool: `search_items` ‚Üí busca sem√¢ntica + filtros
  - [ ] Tool: `enrich_metadata` ‚Üí TMDB/YouTube/OG enrichment
  - [ ] Tool: `classify_content` ‚Üí detecta tipo de conte√∫do
  - [ ] Tool: `get_streaming_availability` ‚Üí provedor streaming
  - [ ] Tool: `update_item_status` ‚Üí marca como visto/lido
  - [ ] Tool: `recommend_similar` ‚Üí sugest√µes baseadas em item

- [ ] **6.4 MCP Prompts**

  - [ ] Prompt: `categorize_item` ‚Üí template classifica√ß√£o
  - [ ] Prompt: `enrich_metadata` ‚Üí template enrichment
  - [ ] Prompt: `recommend_similar` ‚Üí sugest√µes baseadas em AI

- [ ] **6.5 Supabase MCP Integration**

  - [ ] Instalar [Supabase MCP](https://github.com/modelcontextprotocol/servers/tree/main/src/supabase)
  - [ ] Configurar claude_desktop_config.json com ambos MCPs
  - [ ] Documentar queries SQL √∫teis (analytics, debug)
  - [ ] Exemplos de uso combinado (Nexo AI actions + Supabase queries)

- [ ] **6.6 Testing**
  - [ ] Testar com Claude Desktop (multi-server)
  - [ ] Testar com MCP CLI
  - [ ] Testar composi√ß√£o Nexo AI MCP + Supabase MCP
  - [ ] Documentar setup MCP completo

**Exemplo de Config Multi-Server:**

```json
{
  "mcpServers": {
    "nexo-ai": {
      "command": "node",
      "args": ["/path/to/nexo-ai/dist/mcp.js"]
    },
    "supabase": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-supabase"],
      "env": {
        "SUPABASE_URL": "https://xxx.supabase.co",
        "SUPABASE_SERVICE_ROLE_KEY": "eyJxxx..."
      }
    }
  }
}
```

**Use Cases:**

- **Claude**: "Salve o filme 'Inception'" ‚Üí usa `nexo-ai.save_item`
- **Claude**: "Quantos filmes eu tenho salvos?" ‚Üí usa `supabase` SQL query
- **Claude**: "Enrique√ßa o filme 'Interstellar'" ‚Üí usa `nexo-ai.enrich_metadata`
- **Claude**: "Mostre items salvos nos √∫ltimos 7 dias" ‚Üí usa `supabase` SQL com WHERE

**Refer√™ncias:**

- [MCP Supabase Server](https://github.com/modelcontextprotocol/servers/tree/main/src/supabase)
- [MCP Specification](https://modelcontextprotocol.io/docs/specification)
- [MCP Multi-Server Config](https://modelcontextprotocol.io/docs/tools/cli#multiple-servers)

**Entreg√°vel:** Nexo AI MCP + Supabase MCP funcionando em composi√ß√£o

---

## üîÑ Phase 7: Advanced State Machine (Feature Futura)

**Objetivo:** Evoluir state machine para suportar fluxos complexos, paralelos e nested states

### Contexto

State machine atual √© **manual e simples** (7 estados, transi√ß√µes lineares). Esta fase prepara o sistema para cen√°rios avan√ßados quando a complexidade aumentar.

**Implementa√ß√£o Atual (v0.2.0):**

- ‚úÖ Estados b√°sicos: `idle`, `awaiting_confirmation`, `enriching`, `saving`, `error`
- ‚úÖ **NOVO:** `batch_processing`, `awaiting_batch_item` (processamento sequencial de listas)
- ‚úÖ Contexto com fila: `batch_queue[]`, `batch_current_index`, `batch_confirmed_items[]`
- ‚úÖ Fluxo: Detecta lista ‚Üí Processa item por item ‚Üí Aguarda confirma√ß√£o ‚Üí Pr√≥ximo item ‚Üí Completa

**Quando migrar para XState:**

- ‚ö†Ô∏è Sistema atingir **> 10 estados** diferentes
- ‚ö†Ô∏è Necessidade de **nested states** (ex: `batch_processing.idle`, `batch_processing.confirming`)
- ‚ö†Ô∏è Paraleliza√ß√£o (processar m√∫ltiplos fluxos simult√¢neos)
- ‚ö†Ô∏è Transi√ß√µes condicionais complexas com guards
- ‚ö†Ô∏è Hist√≥rico de estados (back/undo)
- ‚ö†Ô∏è Timers e delays autom√°ticos

**Por enquanto:** Implementa√ß√£o manual est√° **boa o suficiente** üëç

### Cen√°rios Complexos Implementados (v0.2.0)

#### ‚úÖ Batch Processing com Fila Sequencial

```
Usu√°rio: "clube da luta, matrix, interestelar"

Bot: üìã Detectei 3 itens!
     1. clube da luta
     2. matrix
     3. interestelar

     ‚è≥ Buscando informa√ß√µes...

     [1/3] **clube da luta**
     Encontrei:
     1. Fight Club (1999)
     2. The Fight Club (2020)

     Qual voc√™ quer? (Digite o n√∫mero)
     üìã Depois confirmo os outros 2 filmes

Usu√°rio: "1"

Bot: ‚úÖ Fight Club (1999) salvo!

     [2/3] **matrix**
     1. The Matrix (1999) ‚úÖ Salvando...

     [3/3] **interestelar**
     Encontrei:
     1. Interstellar (2014)
     2. Interstellar Wars (2008)

     Qual voc√™ quer?
```

**Estado durante processamento:**

```typescript
{
  state: "awaiting_batch_item",
  context: {
    batch_queue: [
      { query: "clube da luta", type: "movie", status: "confirmed" },
      { query: "matrix", type: "movie", status: "confirmed" },
      { query: "interestelar", type: "movie", status: "processing" }
    ],
    batch_current_index: 2,
    batch_current_candidates: [...],
    batch_confirmed_items: [
      { title: "Fight Club", year: "1999" },
      { title: "The Matrix", year: "1999" }
    ]
  }
}
```

**Awareness da Fila:**

- ‚úÖ Bot sabe quantos itens faltam processar
- ‚úÖ Mostra progresso: `[2/3]`
- ‚úÖ Aguarda m√∫ltiplas mensagens at√© confirmar item atual
- ‚úÖ S√≥ avan√ßa quando usu√°rio confirma
- ‚úÖ Resumo final com todos os itens salvos

---

### üìä Phase 7.1: Type-Safe Transitions (v0.3.0)

**Objetivo:** Adicionar valida√ß√£o de transi√ß√µes sem depend√™ncias externas

#### Tasks

- [ ] **7.1.1 State Machine Layer**

  - [ ] Criar `services/conversation/state-machine.ts`
  - [ ] Definir `ConversationEvent` types
  - [ ] Implementar matriz de transi√ß√µes
  - [ ] Fun√ß√£o `transition(state, event)` com valida√ß√£o
  - [ ] Fun√ß√£o `canTransition(state, event)` helper

- [ ] **7.1.2 Integra√ß√£o com Conversation Service**

  - [ ] Modificar `conversation-service.ts`
  - [ ] Usar `transition()` ao inv√©s de `updateState()` direto
  - [ ] Adicionar logs de transi√ß√µes
  - [ ] Error handling para transi√ß√µes inv√°lidas

- [ ] **7.1.3 Novos Estados**

  - [ ] Adicionar `processing` (classificando + buscando)
  - [ ] Adicionar `validating` (checando duplicatas)
  - [ ] Adicionar `editing` (modificando item)

- [ ] **7.1.4 Testing**
  - [ ] Unit tests para matriz de transi√ß√µes
  - [ ] Integration tests de fluxos completos
  - [ ] Test invalid transitions (should throw)

**Estrutura de Arquivos:**

```
src/services/conversation/
‚îú‚îÄ‚îÄ conversation-service.ts (modificado)
‚îú‚îÄ‚îÄ state-machine.ts (novo)
‚îî‚îÄ‚îÄ types.ts (novo)
```

**Exemplo de Implementa√ß√£o:**

```typescript
// state-machine.ts
export type State =
  | "idle"
  | "awaiting_confirmation"
  | "enriching"
  | "saving"
  | "error";

export type Event =
  | { type: "DETECT_CONTENT"; contentType: ItemType; query: string }
  | { type: "CONFIRM_SELECTION"; index: number }
  | { type: "ENRICH_SUCCESS"; metadata: any }
  | { type: "SAVE_SUCCESS" }
  | { type: "ERROR"; message: string };

const transitions: Record<State, Partial<Record<Event["type"], State>>> = {
  idle: { DETECT_CONTENT: "awaiting_confirmation" },
  awaiting_confirmation: {
    CONFIRM_SELECTION: "enriching",
    ERROR: "error",
  },
  enriching: {
    ENRICH_SUCCESS: "saving",
    ERROR: "error",
  },
  saving: {
    SAVE_SUCCESS: "idle",
    ERROR: "error",
  },
  error: { DETECT_CONTENT: "idle" },
};

export function transition(currentState: State, event: Event): State {
  const nextState = transitions[currentState][event.type];

  if (!nextState) {
    throw new Error(`Invalid transition: ${currentState} + ${event.type}`);
  }

  console.log(`State: ${currentState} ‚Üí ${nextState}`);
  return nextState;
}
```

**Entreg√°vel:** Transi√ß√µes type-safe sem depend√™ncias

---

### üîÄ Phase 7.2: Nested & Parallel States (v0.4.0)

**Objetivo:** Suportar sub-estados e opera√ß√µes paralelas (quando necess√°rio)

#### Tasks

- [ ] **7.2.1 Nested States Design**

  - [ ] Mapear fluxos que precisam substates
  - [ ] Exemplo: `processing: { classifying, searching, singleResult, multipleResults }`
  - [ ] Documentar hierarquia de estados

- [ ] **7.2.2 Parallel States Design**

  - [ ] Identificar opera√ß√µes que podem rodar em paralelo
  - [ ] Exemplo: `enriching: { tmdb, streaming, aiTags }` (paralelo)
  - [ ] Definir estrat√©gia de sincroniza√ß√£o

- [ ] **7.2.3 Implementa√ß√£o Manual** (op√ß√£o 1)

  - [ ] Estender `state-machine.ts` com nested support
  - [ ] Formato: `"processing.searching"` (dot notation)
  - [ ] Parallel via Promise.all() + flags no context

- [ ] **7.2.4 Avaliar XState** (op√ß√£o 2)
  - [ ] PoC com XState
  - [ ] Comparar bundle size vs features
  - [ ] Decis√£o: implementar ou postergar

**Entreg√°vel:** Suporte a nested/parallel OU decis√£o de adiar XState

---

### ü§ñ Phase 7.3: XState Migration (v0.5.0+)

**Objetivo:** Migrar para XState se cen√°rios avan√ßados forem necess√°rios

#### Pre-requisitos para Migra√ß√£o

Implementar **APENAS SE** atingir 2+ destes cen√°rios:

- ‚úÖ Sistema tem > 10 estados
- ‚úÖ Precisa de nested states em produ√ß√£o
- ‚úÖ Precisa de parallel states nativos
- ‚úÖ Guards complexos (condi√ß√µes nas transi√ß√µes)
- ‚úÖ Actions autom√°ticas (hooks em entrada/sa√≠da)
- ‚úÖ History states (navega√ß√£o "voltar")
- ‚úÖ Time > 3 devs (benef√≠cio de visualiza√ß√£o)

#### Tasks

- [ ] **7.3.1 XState Setup**

  - [ ] Instalar `xstate` + `@xstate/inspect`
  - [ ] Criar `src/machines/conversation-machine.ts`
  - [ ] Migrar estados atuais para XState format

- [ ] **7.3.2 Machine Adapter**

  - [ ] Criar `services/conversation/machine-adapter.ts`
  - [ ] Wrapper para `interpret()` do XState
  - [ ] Bridge entre XState e conversation-service

- [ ] **7.3.3 Advanced Features**

  - [ ] Implementar nested states
  - [ ] Implementar parallel states
  - [ ] Adicionar guards/actions
  - [ ] History states para edi√ß√£o

- [ ] **7.3.4 Visualization**

  - [ ] Configurar @xstate/inspect
  - [ ] Documenta√ß√£o visual via Stately.ai
  - [ ] Export diagrams para docs/

- [ ] **7.3.5 Testing & Migration**
  - [ ] Testes end-to-end com XState
  - [ ] Migra√ß√£o incremental (feature flag)
  - [ ] Rollback plan

**Estrutura de Arquivos:**

```
src/
‚îú‚îÄ‚îÄ machines/
‚îÇ   ‚îú‚îÄ‚îÄ conversation-machine.ts
‚îÇ   ‚îú‚îÄ‚îÄ enrichment-machine.ts
‚îÇ   ‚îî‚îÄ‚îÄ types.ts
‚îú‚îÄ‚îÄ services/conversation/
‚îÇ   ‚îú‚îÄ‚îÄ conversation-service.ts (usa machine-adapter)
‚îÇ   ‚îî‚îÄ‚îÄ machine-adapter.ts (wrapper XState)
```

**Exemplo de XState Machine:**

```typescript
// conversation-machine.ts
import { createMachine } from "xstate";

export const conversationMachine = createMachine({
  id: "conversation",
  initial: "idle",

  states: {
    idle: {
      on: { DETECT_CONTENT: "processing" },
    },

    processing: {
      initial: "classifying",
      states: {
        classifying: {
          invoke: {
            src: "classifyContent",
            onDone: { target: "searching" },
          },
        },
        searching: {
          invoke: {
            src: "searchExternal",
            onDone: [
              { target: "singleResult", cond: "isSingleResult" },
              { target: "multipleResults" },
            ],
          },
        },
        singleResult: {
          on: { CONFIRM: "#conversation.enriching" },
        },
        multipleResults: {
          on: { SELECT: "singleResult" },
        },
      },
    },

    enriching: {
      type: "parallel",
      states: {
        tmdb: {
          initial: "loading",
          states: {
            loading: {
              invoke: {
                src: "fetchTMDB",
                onDone: "success",
              },
            },
            success: { type: "final" },
          },
        },
        streaming: {
          initial: "loading",
          states: {
            loading: {
              invoke: {
                src: "fetchStreaming",
                onDone: "success",
              },
            },
            success: { type: "final" },
          },
        },
      },
      onDone: "saving",
    },

    saving: {
      invoke: {
        src: "saveItem",
        onDone: "idle",
      },
    },
  },
});
```

**Entreg√°vel:** State machine com XState (apenas se necess√°rio)

---

### üìà M√©tricas de Decis√£o

| M√©trica               | Phase 7.1 | Phase 7.2 | Phase 7.3   |
| --------------------- | --------- | --------- | ----------- |
| **N√∫mero de Estados** | 5-7       | 8-12      | 12+         |
| **Nested States**     | ‚ùå        | Manual    | Nativo      |
| **Parallel States**   | ‚ùå        | Manual    | Nativo      |
| **Guards/Actions**    | ‚ùå        | Manual    | Declarativo |
| **Visualiza√ß√£o**      | ‚ùå        | ‚ùå        | Stately.ai  |
| **Bundle Size**       | 0kb       | 0kb       | +40kb       |
| **Complexidade**      | Baixa     | M√©dia     | Alta        |

**Regra de Decis√£o:**

- Phase 7.1: ‚úÖ **Implementar sempre** (type-safety)
- Phase 7.2: Implementar **SE** > 8 estados ou precisar de parallel
- Phase 7.3: Implementar **SE** 2+ cen√°rios complexos

---

### üéØ Roadmap de Implementa√ß√£o

```mermaid
graph TD
    A[Phase 7.1: Type-Safe] --> B{> 8 estados?}
    B -->|Sim| C[Phase 7.2: Nested/Parallel]
    B -->|N√£o| D[Manter 7.1]
    C --> E{2+ cen√°rios complexos?}
    E -->|Sim| F[Phase 7.3: XState]
    E -->|N√£o| G[Manter 7.2]
```

**Prioridade:** M√©dia (implementar 7.1 em v0.3.0, avaliar 7.2/7.3 depois)

**Refer√™ncias:**

- [ADR-008: Advanced State Machine](adr/008-advanced-state-machine.md)
- [XState Documentation](https://xstate.js.org/docs/)
- [ADR-004: State Machine Original](adr/004-state-machine.md)

---

## üìã Phase 7: Auth & Multi-User (Semana 4) - **PLANEJADO**

**Objetivo:** Suporte multi-usu√°rio com autentica√ß√£o

### Tasks

- [ ] **7.1 Supabase Auth Setup**

  - [ ] Habilitar Email/Password auth
  - [ ] Configurar email templates
  - [ ] Setup RLS (Row Level Security)

- [ ] **7.2 Auth Endpoints**

  - [ ] `POST /auth/signup`
  - [ ] `POST /auth/login`
  - [ ] `POST /auth/refresh`
  - [ ] `POST /auth/logout`
  - [ ] `POST /auth/reset-password`

- [ ] **7.3 Auth Middleware**

  - [ ] Verificar JWT em todas as rotas protegidas
  - [ ] Extrair userId do token
  - [ ] Injetar no context da request

- [ ] **7.4 User Management**

  - [ ] Vincular WhatsApp number ao user ID
  - [ ] Permitir m√∫ltiplos n√∫meros por user
  - [ ] Settings/preferences por user

- [ ] **7.5 Permission Checks**
  - [ ] User s√≥ acessa pr√≥prios items
  - [ ] User s√≥ acessa pr√≥prias conversas
  - [ ] Admin role (futuro)

**Entreg√°vel:** Sistema multi-usu√°rio seguro

---

## üìã Phase 8: Polish & Improvements (Semana 4-5) - **PLANEJADO**

**Objetivo:** Refinamentos e features auxiliares

### Tasks

- [ ] **8.1 Error Handling**

  - [ ] Custom error classes
  - [ ] Error codes padronizados
  - [ ] Logs estruturados
  - [ ] Sentry integration (opcional)

- [ ] **8.2 Rate Limiting**

  - [ ] Per-endpoint limits
  - [ ] Per-user limits
  - [ ] Cloudflare rate limiting rules

- [ ] **8.3 Caching**

  - [ ] Cache TMDB responses (Cloudflare KV)
  - [ ] Cache YouTube responses
  - [ ] Cache OpenGraph (1 hora)

- [ ] **8.4 Bulk Operations**

  - [ ] `POST /items/bulk` (criar m√∫ltiplos)
  - [ ] `PATCH /items/bulk` (update m√∫ltiplos)
  - [ ] `DELETE /items/bulk` (deletar m√∫ltiplos)

- [ ] **8.5 Export/Import**

  - [ ] `GET /items/export` (JSON/CSV)
  - [ ] `POST /items/import` (JSON/CSV)
  - [ ] Backup completo do usu√°rio

- [ ] **8.6 Webhooks Outgoing**

  - [ ] Notificar external systems em events
  - [ ] `POST /webhooks` (register)
  - [ ] Signature validation

- [ ] **8.7 Testing**
  - [ ] Unit tests (services)
  - [ ] Integration tests (routes + DB)
  - [ ] E2E tests (WhatsApp flow completo)
  - [ ] CI/CD setup (GitHub Actions)

**Entreg√°vel:** Sistema robusto e testado

---

## üöÄ Phase 9: Advanced Features (Futuro)

**Objetivo:** Features avan√ßadas p√≥s-MVP

### Future Tasks

- [ ] **9.1 Smart Recommendations**

  - [ ] ML model ou Claude para recomendar items similares
  - [ ] "Baseado no que voc√™ salvou..."

- [ ] **9.2 Reminders & Notifications**

  - [ ] Cron jobs (Cloudflare Workers Cron)
  - [ ] Enviar lembretes via WhatsApp
  - [ ] "Voc√™ salvou X h√° 1 semana, j√° assistiu?"

- [ ] **9.3 Web Dashboard**

  - [ ] Frontend React/Next.js
  - [ ] Visualizar/gerenciar items
  - [ ] Analytics e gr√°ficos

- [ ] **9.4 Voice Messages**

  - [ ] Receber √°udios WhatsApp
  - [ ] Transcrever com Whisper API
  - [ ] Processar como texto

- [ ] **9.5 Image Recognition**

  - [ ] Receber imagens (cartazes, screenshots)
  - [ ] OCR + Claude Vision
  - [ ] Identificar filme/jogo/livro

- [ ] **9.6 More Enrichment Sources**

  - [ ] Spotify (m√∫sica)
  - [ ] Goodreads (livros)
  - [ ] Steam (jogos)
  - [ ] Trakt.tv (tracking filmes/s√©ries)

- [ ] **9.7 Collaborative Lists**

  - [ ] Compartilhar listas com amigos
  - [ ] Permiss√µes (view, edit)
  - [ ] Comments nos items

- [ ] **9.8 Calendar Integration**

  - [ ] Sync reminders com Google Calendar
  - [ ] iCal export

- [ ] **9.9 Mobile App**
  - [ ] React Native app
  - [ ] Notifica√ß√µes push
  - [ ] Offline support

---

## üéØ Milestones

| Milestone             | Data Estimada | Entreg√°vel                  | Status       |
| --------------------- | ------------- | --------------------------- | ------------ |
| M1: Hello World       | Semana 1      | API + WhatsApp responde     | ‚úÖ Completo  |
| M2: MVP Core          | Semana 3      | Claude + Enrichment + CRUD  | ‚úÖ Completo  |
| M3: Production Ready  | Semana 5      | Auth + Tests + Deploy       | üöß 40%       |
| M4: Advanced Features | Semana 8+     | Recommendations + Dashboard | üìã Planejado |

---

## üìä M√©tricas de Sucesso

### MVP (M2) - ‚úÖ **ALCAN√áADO**

- ‚úÖ 10 usu√°rios beta testando
- ‚úÖ 100+ items salvos
- ‚úÖ 90% das mensagens processadas corretamente
- ‚úÖ < 5s tempo de resposta m√©dio

### Production (M3) - üéØ **PR√ìXIMO**

- [ ] 100 usu√°rios ativos
- [ ] 99.9% uptime
- [ ] < 2s tempo de resposta m√©dio
- [ ] 0 critical bugs

### Scale (M4) - üìã **FUTURO**

- [ ] 1000+ usu√°rios
- [ ] 10k+ items salvos
- [ ] Custo < $200/m√™s
- [ ] NPS > 50

---

## üé® Prioriza√ß√£o

### Must Have (MVP) - ‚úÖ **IMPLEMENTADO**

- [x] WhatsApp integration
- [x] Claude AI + basic integration
- [x] Enrichment (TMDB, YouTube, OpenGraph)
- [x] Items CRUD b√°sico
- [x] Basic search

### Should Have (v0.2.0) - ÔøΩ **PLANEJADO**

- [ ] WhatsApp integration (ativar quando necess√°rio)
- [ ] Dashboard web para linking manual de contas
- [ ] Advanced error handling
- [ ] Rate limiting
- [ ] Caching
- [ ] Webhook signature validation
- [ ] Tests (unit + integration)

### Should Have (v0.3.0) - üìã **PLANEJADO**

- [ ] Discord integration
- [ ] Suporte a outros providers (Slack, etc)
- [ ] Auth multi-user
- [ ] Advanced search (full-text)
- [ ] Stats/analytics
- [ ] Export/import

### Nice to Have (v0.4.0+) - üìã **PLANEJADO**

- [ ] MCP server
- [ ] Voice messages
- [ ] Web dashboard
- [ ] Image recognition

### Nice to Have (v0.5.0+) - üîÆ **FUTURO**

- [ ] Google Calendar integration (Phase 8)
- [ ] Microsoft To Do integration (Phase 8)
- [ ] Semantic search with pgvector (Phase 9)
- [ ] Recommendations with embeddings (Phase 9)
- [ ] Hybrid search (structured + semantic)

### Won't Have (Now)

- [ ] Mobile app nativo
- [ ] Collaborative features
- [ ] Offline support

---

## ‚ö†Ô∏è Riscos e Mitiga√ß√µes

| Risco                 | Impacto | Probabilidade | Mitiga√ß√£o                   |
| --------------------- | ------- | ------------- | --------------------------- |
| Meta API inst√°vel     | Alto    | M√©dio         | Retry logic, queue          |
| Claude API caro       | M√©dio   | Alto          | Cache, otimizar prompts     |
| Rate limits excedidos | M√©dio   | M√©dio         | Caching, user education     |
| DB overload           | Alto    | Baixo         | Indexes, connection pooling |
| Spam/abuse            | M√©dio   | M√©dio         | Rate limiting per user      |

---

## üì¶ Dependencies & Blockers

- ‚úÖ Supabase setup ‚Üí ~~Bloqueia Phase 1-2~~
- ‚úÖ Meta WhatsApp approval ‚Üí ~~Bloqueia Phase 2~~
- ‚úÖ Claude API access ‚Üí ~~Bloqueia Phase 3~~
- ‚úÖ TMDB/YouTube keys ‚Üí ~~Bloqueia Phase 4~~

---

## üë• Team

- **Backend**: 1 dev (voc√™)
- **Frontend**: (futuro)
- **Design**: (futuro)
- **QA**: Manual testing inicial

---

## üöÄ Release Strategy

### Beta (Private) - ‚úÖ **ATUAL**

- 10-20 usu√°rios selecionados
- Feedback direto via WhatsApp group
- Itera√ß√£o r√°pida (deploy di√°rio)

### Public Launch - üìã **PR√ìXIMO (M3)**

- Blog post + Product Hunt
- Twitter announcement
- Demo video

### Ongoing

- Weekly updates
- Monthly feature releases
- Quarterly roadmap review

---

## üéØ Princ√≠pios de Desenvolvimento

1. **Simplicidade primeiro** - Features simples e funcionais
2. **Qualidade > Velocidade** - N√£o sacrificar qualidade por features
3. **User feedback** - Iterar baseado em uso real
4. **Provider-agnostic** - F√°cil trocar LLM/APIs
5. **Open source** - Comunidade pode contribuir

---

**Let's build!** üöÄ
